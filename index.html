<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pengesan Alamat Sekolah</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 18px; max-width: 720px; margin: auto; }
    pre { background:#f4f4f4; padding: 10px; border-radius: 6px; }
    .hi { color: green; font-weight: 700; }
    .bye { color: red; font-weight: 700; }
  </style>
</head>
<body>
  <h1>Pengesan Alamat Sekolah</h1>
  <p>Diubah hala secara automatik ke borang kehadiran jika anda berada di SK Raja Dihilir Ekram. </p>

  <h3>Status</h3>
  <p id="status">Idle</p>

  <h3>Coordinates</h3>
  <p id="coords">—</p>

  <h3>Detected Address</h3>
  <pre id="address">—</pre>

  <h3>Result</h3>
  <p id="result">—</p>

<script>
const KEYWORDS = ["raja", "ekram"];

// normalize string to lowercase and collapse spaces
function normalize(str) {
  return str?.toLowerCase().replace(/\s+/g, ' ').trim() || '';
}

// check if any keyword exists in the address
function containsKeyword(address) {
  const norm = normalize(address);
  return KEYWORDS.some(k => norm.includes(k));
}

async function detectAndRedirect() {
  const statusEl = document.getElementById('status');
  const coordsEl = document.getElementById('coords');
  const addressEl = document.getElementById('address');
  const resultEl = document.getElementById('result');

  statusEl.textContent = 'Requesting location…';
  coordsEl.textContent = '—';
  addressEl.textContent = '—';
  resultEl.textContent = '—';

  if (!navigator.geolocation) {
    statusEl.textContent = 'Geolocation not supported.';
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    coordsEl.textContent = `Latitude: ${lat}\nLongitude: ${lon}`;
    statusEl.textContent = 'Reverse-geocoding…';

    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=0`;
      const resp = await fetch(url);

      if (!resp.ok) throw new Error('Reverse geocode failed: ' + resp.status);

      const json = await resp.json();
      const displayName = json.display_name || '';
      addressEl.textContent = displayName;

      if (containsKeyword(displayName)) {
        resultEl.innerHTML = `<span class="hi">hi</span> - Redirecting…`;
        statusEl.textContent = 'Keyword found, redirecting…';
        window.location.href = "https://borangkehadiran.github.io/Borang-Kehadiran-Guru-SKRDHE/";
      } else {
        resultEl.innerHTML = `<span class="bye">Sila pergi ke SK Raja Dihilir Ekram</span>`;
        statusEl.textContent = 'Keyword not found.';
      }

    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error fetching address: ' + err.message;
      addressEl.textContent = '—';
      resultEl.textContent = '—';
    }

  }, (err) => {
    switch(err.code) {
      case err.PERMISSION_DENIED: statusEl.textContent = 'User denied geolocation.'; break;
      case err.POSITION_UNAVAILABLE: statusEl.textContent = 'Position unavailable.'; break;
      case err.TIMEOUT: statusEl.textContent = 'Geolocation timed out.'; break;
      default: statusEl.textContent = 'Geolocation error: ' + err.message;
    }
    coordsEl.textContent = '—';
    addressEl.textContent = '—';
    resultEl.textContent = '—';
  }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
}

// Run automatically on page load
window.addEventListener('load', detectAndRedirect);
</script>
</body>
</html>
